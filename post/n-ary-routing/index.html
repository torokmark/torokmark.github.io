<!DOCTYPE html>
<html>
    <head>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154887805-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-154887805-1');
        </script>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>How to implement routing with n-ary tree</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              
              
              <a class="nav-item nav-link " href="/contact/">Contact</a>
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          <h1><a href="/">T[h]ink]er[ing</a></h1>
          <span id="author-name">
            <h6><a href="/about/"></a></h6>
          </span>
        </section>


<div class="blog-post">
  <h1>How to implement routing with n-ary tree</h1>
  <div class="blog-post-subheader">
    <time>19 Mar 2019</time>
  </div>
  <div class="blog-post-content">
    

<p><strong>Routing mechanism is one of the main parts of a web service. Here I provide one approach
to achieve this. This implementation is based on n-ary tree and tree search.</strong></p>

<p>Many ways are available to handle <em>routes</em>, from regex to n-ary trees to parse
registered route one by one.</p>

<h3 id="different-ways">Different ways</h3>

<h4 id="n-ary-trees">N-ary Trees</h4>

<p>In this approach we can consider the root node as <code>/</code> and all children nodes as
route parts are separated by <code>/</code>. Every part is on a separated level of the
tree. A node contains one route part.</p>

<p>A route part can be either a string which requires full match or a <em>path param</em>
which is a string surrounded by curly brackets (<code>{}</code>) also acceptable.</p>

<h4 id="regex">Regex</h4>

<p>All defined routes go into a stack in the order of definition.
During procession the earlier match is executed or returns the result of the executed lambda.</p>

<h4 id="parse-one-by-one">Parse one by one</h4>

<p>This approach is very similar to the above one but without regex. Let us consider a registered
route as a key in a dictionary. The value is the lambda which is intended to be executed when
call falls on the route.</p>

<p>After iterating over the keys of the dictionary either use regex to identify the
appropriate route or parse them and process by using string operations (for
those who are not into regex).</p>

<h4 id="rule-objects">Rule objects</h4>

<p>Tornado framework provides a fine-grained mechanism to define and implement routings.
The framework introduced rules and delegators parse and execute expressions.</p>

<h3 id="the-approach">The Approach</h3>

<p>In this solution the n-ary tree approach is chosen. Each node contains one part
of the route, depth of the tree equals to the longest route splitted by <code>/</code>.
All children of a node contain the next route part after the node value
separated by <code>/</code>.</p>

<h4 id="register-a-route">Register a route</h4>

<p>For route registration we can use the <code>register</code> function. It takes the route
itself, which will be parsed, splitted and considered as an identifier part.
The whole identifier of a node is the path inside the tree from the root to the
given node. Method is also part of the identifier that means the same route with
different methods are placed in two different nodes as siblings.
<code>params</code> are considered as a whitelist of queryparams. Those queryparams that
are not in this list, those are not parsed and processed, and passed to the
lambda.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">routing<span style="color:#f92672">.</span>register(route<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/users&#39;</span>, 
                 callback<span style="color:#f92672">=</span>(<span style="color:#66d9ef">lambda</span> name, email: users<span style="color:#f92672">.</span>create_user(name, email)),
                 method<span style="color:#f92672">=</span>routing<span style="color:#f92672">.</span>Methods<span style="color:#f92672">.</span>POST,
                 params<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>})

routing<span style="color:#f92672">.</span>register(route<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/users/{id}&#39;</span>, 
                 callback<span style="color:#f92672">=</span>(<span style="color:#66d9ef">lambda</span> id: users<span style="color:#f92672">.</span>get_user(id)), 
                 method<span style="color:#f92672">=</span>routing<span style="color:#f92672">.</span>Methods<span style="color:#f92672">.</span>GET)</code></pre></div>
<h4 id="process-a-route">Process a route</h4>

<p>The <code>process</code> function takes the three agruments as shown below and returns the
result of the executed lambda. If lambda returns void than process gives back
<code>None</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">request_body <span style="color:#f92672">=</span> routing<span style="color:#f92672">.</span>process(event<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;path&#39;</span>), 
                               event<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;queryStringParameters&#39;</span>), 
                               event<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;httpMethod&#39;</span>))</code></pre></div>
<h4 id="routing-tree">Routing Tree</h4>

<p>Routing tree represents the registered routes. Each <em>node</em> contains the route part,
the full path from the root to itself, <em>callbacks</em> and children nodes.</p>

<p>Callbacks are stored in a dictionary with methods as keys and lambdas as values.
So this way one path could have a <code>POST</code> and a <code>GET</code> or any other methods at the
same time.</p>

<p>A node looks like as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">(<span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#a6e22e">resource_path</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#a6e22e">callbacks</span><span style="color:#f92672">=</span>{} <span style="color:#a6e22e">children</span><span style="color:#f92672">:</span> [
  (<span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;users&#34;</span> <span style="color:#a6e22e">resource_path</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/users&#39;</span> <span style="color:#a6e22e">callbacks</span><span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;GET&#39;</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">callback</span><span style="color:#f92672">=</span>
  <span style="color:#a6e22e">lambda</span><span style="color:#f92672">-</span><span style="color:#a6e22e">expression</span>,
  <span style="color:#a6e22e">params</span><span style="color:#f92672">=</span>{}}}  <span style="color:#a6e22e">children</span><span style="color:#f92672">:</span> [])
])
</code></pre></div>
<p>The routing tree has two methods that can build the tree up or find the
appropriate path.</p>

<ul>
<li><strong>add</strong>: responsible to handle the registration recursively.</li>
<li><strong>find</strong>: responsible for evaluation of the call.</li>
</ul>

<p>Both methods traverse the tree recursively, finding matching parts.
If parts found, and no other path left, it returns the appropriate value, or it goes
towards to one of the children if necessary.</p>

<h4 id="add-route-with-pathparam">Add route with pathparam</h4>

<p>Pathparam is also part of the representation so it goes as a node value, like
<code>{id}</code>.
This implementation requires that no multiple pathparam names are allowed.
That means no <code>{id}</code> and <code>{user_id}</code> are allowed at the same time.</p>

<h4 id="process-a-call">Process a call</h4>

<p>Routing trees <code>find</code> method is responsible for getting back the lambda call
based on the route path and the method. If one of them are differ from what the
tree contains, <code>find</code> raise an error accordingly.</p>

<p>At first, <code>find</code> checks wether the path on a given node could match. If so, it
traverse through children searching for exact matching. If no matching found on
the level, it considers the path as a pathparam and goes towards the children of
the pathparam node.</p>

<h4 id="validation">Validation</h4>

<p><code>register</code> as well as <code>process</code> have their own validators against injections and malicious
characters that can mess up with the database.</p>

<p>Here I used very simple validation by using regex, but it is alterable according
to the needs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">PATH_PARAM_PATTERN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^{([a-zA-Z0-9]+)}$&#39;</span>
PATH_PART_PATTERN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^[a-zA-Z0-9\-]+$&#39;</span>

QUERY_KEY_PATTERN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^[a-zA-Z0-9]+$&#39;</span>
QUERY_VALUE_PATTERN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;(^[a-zA-Z0-9\-@\. ]+$)&#39;</span></code></pre></div>
<p>The implementation gives a chance to fine-tune the validation by introducing
param specific patterns. These could be placed in either <code>validate_route_register</code> or
<code>validate_route_process</code> or in both.</p>

<h4 id="what-it-does-not-contain">What it does not contain</h4>

<p>It is an experimental project so it lacks some other features.
The implementation of these features does not require much alteration on the
code, though I leave it for others. The list below.</p>

<ul>
<li>Process request body and send data as JSON</li>
<li>Optional params for <code>PATCH</code></li>
<li>Validate params to avoid updating id</li>
<li>Context param of handler func</li>
<li>Builder for response (which can be found in my other post)</li>
</ul>

<p><strong>In this post we saw one approach of implementing routing in python, how to
declare route with method, params and lambda, and took a look on how to process it.</strong></p>

<p>For further reading and for the implementation you can visit <a href="https://github.com/torokmark/routing_python">https://github.com/torokmark/routing_python</a>.</p>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2020 .
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> using the <a href="https://github.com/arjunkrishnababu96/basics" target="_blank">Basics</a> theme.
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </body>
</html>

