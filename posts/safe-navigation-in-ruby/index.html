<!DOCTYPE html>
<html>
    <head>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154887805-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-154887805-1');
        </script>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>Safe navigation in Ruby</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              
              
              <a class="nav-item nav-link " href="/contact/">Contact</a>
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          <h1><a href="/">T[h]ink]er[ing</a></h1>
          <span id="author-name">
            <h6><a href="/about/"></a></h6>
          </span>
        </section>


<div class="blog-post">
  <h1>Safe navigation in Ruby</h1>
  <div class="blog-post-subheader">
    <time>17 Jun 2019</time>
  </div>
  <div class="blog-post-content">
    <p><strong>Navigation through embedded objects can suprise us with an error if one of the
fields, which are objects as well, is null. We are in the same situation if we
have a hash object and want to get a value by key if key does not exist.
The burning situation crops up if we chain up methods next to each other.</strong></p>
<p>In this post I write some approaches, how to keep our code still
clean, readable and safe if we liked to chain up calls next one another on an
object or on a key-value pair container.</p>
<p>Demonstration of the core problem comes below:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Address</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:city</span><span class="p">,</span> <span class="ss">:street</span><span class="p">,</span> <span class="ss">:number</span><span class="p">)</span>
<span class="no">Person</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:age</span><span class="p">,</span> <span class="ss">:address</span><span class="p">)</span>

<span class="n">people</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">people</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;jancsi&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="no">Address</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;somewhere over the rainbow&#39;</span><span class="p">,</span> <span class="s1">&#39;42&#39;</span><span class="p">))</span>
<span class="n">people</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;jancsi&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

<span class="n">people</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
	<span class="nb">p</span> <span class="n">person</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">street</span>
<span class="k">end</span>
<span class="c1"># =&gt; &#39;somewhere over the rainbow&#39;</span>
<span class="c1"># =&gt; `&lt;main&gt;&#39;: undefined method `street&#39; for nil:NilClass (NoMethodError)</span>
</code></pre></div><p>And in case of hash, the same problem looks like that:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">animals</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="n">animals</span><span class="o">[</span><span class="s1">&#39;mammals&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;even-toed&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;giraffe&#39;</span><span class="p">}</span>                                 
<span class="n">animals</span><span class="o">[</span><span class="s1">&#39;reptiles&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;snakes&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;cobra&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;king cobra&#39;</span><span class="p">,</span> <span class="s1">&#39;tree cobra&#39;</span><span class="o">]</span><span class="p">}</span> <span class="p">}</span>

<span class="o">[</span><span class="s1">&#39;mammals&#39;</span><span class="p">,</span> <span class="s1">&#39;reptiles&#39;</span><span class="p">,</span> <span class="s1">&#39;birds&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">animals</span><span class="o">[</span><span class="n">key</span><span class="o">][</span><span class="s1">&#39;snakes&#39;</span><span class="o">]</span>
<span class="k">end</span>
<span class="c1"># =&gt; nil</span>
<span class="c1"># =&gt; {&#34;cobra&#34;=&gt;[&#34;king cobra&#34;, &#34;tree cobra&#34;]}</span>
<span class="c1"># =&gt; Traceback (most recent call last):</span>
<span class="c1"># ...</span>
<span class="c1"># =&gt; navigation.rb:29:in `block in &lt;main&gt;&#39;: undefined method `[]&#39; for nil:NilClass (NoMethodError)</span>
</code></pre></div><h3 id="solution-in-ruby">Solution in Ruby</h3>
<p>Ruby introduced the safe navigation operator <code>&amp;</code> in version 2.3, with which we
can handle null objects.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">people</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
	<span class="nb">p</span> <span class="n">person</span><span class="o">&amp;.</span><span class="n">address</span><span class="o">&amp;.</span><span class="n">street</span>
<span class="k">end</span>
<span class="c1"># =&gt; &#34;somewhere over the rainbow&#34;</span>
<span class="c1"># =&gt; nil</span>
</code></pre></div><p>What if we liked to get a value based on its key and chaining the indices next one another.
If one of the key is missing, indexing would be applied against a null object.
Furtonately, the <code>||</code> operator comes handy.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">p</span> <span class="p">(</span><span class="n">animals</span><span class="o">[</span><span class="s1">&#39;mammals&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="p">{})</span><span class="o">[</span><span class="s1">&#39;snakes&#39;</span><span class="o">]</span>  <span class="c1"># =&gt; nil</span>
<span class="nb">p</span> <span class="p">(</span><span class="n">animals</span><span class="o">[</span><span class="s1">&#39;reptiles&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="p">{})</span><span class="o">[</span><span class="s1">&#39;snakes&#39;</span><span class="o">]</span>  <span class="c1"># =&gt; {&#34;cobra&#34;=&gt;[&#34;king cobra&#34;, &#34;tree cobra&#34;]}</span>
<span class="nb">p</span> <span class="p">(</span><span class="n">animals</span><span class="o">[</span><span class="s1">&#39;birds&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="p">{})</span><span class="o">[</span><span class="s1">&#39;snakes&#39;</span><span class="o">]</span>  <span class="c1"># =&gt; nil</span>
</code></pre></div><p>If the value belongs to the set of falsy values like <code>false</code> we get the same result,
though <code>false</code> can be a valid index.</p>
<p>Let us see what we can do to enhance fetching values by keys from a hash.</p>
<p><code>Hash</code> types brings <code>dig</code> method:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">p</span> <span class="n">animals</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="s1">&#39;mammals&#39;</span><span class="p">,</span> <span class="s1">&#39;snakes&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; nil</span>
<span class="nb">p</span> <span class="n">animals</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="s1">&#39;reptiles&#39;</span><span class="p">,</span> <span class="s1">&#39;snakes&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; {&#34;cobra&#34;=&gt;[&#34;king cobra&#34;, &#34;tree cobra&#34;]}</span>
<span class="nb">p</span> <span class="n">animals</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="s1">&#39;birds&#39;</span><span class="p">,</span> <span class="s1">&#39;snakes&#39;</span><span class="p">)</span>  <span class="c1"># =&gt; nil</span>
</code></pre></div><h3 id="gems">Gems</h3>
<p>Older versions of Ruby (below 2.3) do not support safe navigation, so gems
had been popped up to fill the voidness.
Rails was also one of the firsts that provided a solution. It introduced <code>try</code>
function to check whether an indexing returns null or not.</p>
<p>Rails introduced <code>try</code> to achieve that functionality.<br>
The above code looks like as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">people</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
	<span class="nb">p</span> <span class="n">person</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:address</span><span class="p">)</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:street</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1"># =&gt; &#39;somewhere over the rainbow&#39;</span>
<span class="c1"># =&gt; nil</span>
</code></pre></div><p><strong>So we have got some insight how to handle embedded objects and avoid raising <code>NoMethodError</code> exceptions.</strong></p>
<p>Code can be found: <a href="https://github.com/torokmark/safe-navigation-in-languages">https://github.com/torokmark/safe-navigation-in-languages</a></p>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2020 .
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> using the <a href="https://github.com/arjunkrishnababu96/basics" target="_blank">Basics</a> theme.
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </body>
</html>

